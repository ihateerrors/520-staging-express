
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>SR 520 Construction Dashboard </title>

<link rel="stylesheet" media="all" href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&amp;display=swap" />
<link rel="stylesheet" media="all" href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" />

<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
type="text/css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> 
<link rel="stylesheet" media="all" href="/css/styles3.css" />
<link rel="stylesheet" media="all" href="/css/stylesheet-override2.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<style>

.alert {
    transition: opacity 1s;
}
/* Spacing between entries */
.accordion-item {
    margin-bottom: 20px;
}

/* Uniform button sizes */
.btn {
    width: 100px;  /* Adjust width as needed */
    height: 40px;
    display: inline-block;
}
.date-container {
    display: flex;
    justify-content: space-between;  /* This will distribute the space evenly between the two date items */
    align-items: center;
}

.date-item {
    flex: 1;  /* This will make sure both date items take equal space */
    padding: 0 10px;  /* A little padding for spacing */
}

/* Input styling */
input[type="text"], input[type="date"] {
    min-width: 80%;  /* Takes 80% width of its container for more space */
    border: 1px solid #ced4da;
    padding: 5px 12px;
    border-radius: 4px;  /* Rounded corners */
    margin: 12px 0;  /* Increased vertical spacing */
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);  /* Subtle shadow for depth */
    background-color: #f7f7f7;  /* Light background for contrast */
    display: block;  /* To take up full width and push subsequent content to new line */
}

/* Accordion content styling */
.accordion-body {
    padding: 15px;
}

/* For the images */
.img-fluid {
    margin-top: 10px;
    margin-bottom: 10px;
}

/* For the labels */
strong {
    display: block;
    margin-top: 14px;
    margin-bottom: 5px;  /* Space between label and the associated input */
}

/* Edit and Delete buttons spacing */
.edit-btn, .delete-btn {
    margin-right: 10px;
    margin-top: 10px;
}

/* Improved font styling for accordion button */
.accordion-button.fw-600 {
    font-size: 18px;
    line-height: 30px;
    font-weight: 600;
    text-align: left;
}

</style>
  </head>
  <body>
    
    
    <header id="header" style="width: 100vw">
        <div class="container-fluid header-container">
          <div class="row">
            <div class="col-md-4">
              <div class="headerflex">
                <a
                  class="logo"
                  href="https://wsdot.wa.gov/"
                  title="Home"
                  rel="home"
                  rel="noreferrer"
                >
                  <img
                    src="https://sr520construction.blob.core.windows.net/520-uploads/wsdot-logo-white.svg"
                    alt="Home"
                    loading="lazy"
                    style="float: left; position: sticky; text-decoration: none"
                  />
                </a>
              </div>
            </div>
            <div class="col-md-8">
              <div class="container3">
                <ul class="topnav2" style="float: right">
                  <li class="nodec" style="font-weight: 600; font-size: 16px">
                    <a
                      class="nodec"
                      href="https://wsdot.wa.gov/construction-planning/major-projects/sr-520-bridge-replacement-and-hov-program"
                      >SR 520 Program</a
                    >&nbsp;&nbsp;&nbsp;&nbsp;
                  </li>
                  <li class="nodec" style="font-weight: 600; font-size: 16px">
                    <a class="nodec" href="https://www.wsdot.wa.gov/news/">News</a
                    >&nbsp;&nbsp;&nbsp;&nbsp;
                  </li>
                  <li class="nodec" style="font-weight: 600; font-size: 16px">
                    <a class="nodec" href="https://www.wsdot.wa.gov/goodtogo/"
                      ><em>Good To Go!</em></a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
    </header>
    <div class="container">
         <div class="blockhead navwrap" style="display: block; margin: 3%;"> 
            <h1 class="wdot-dkgreen" style="font-size: 42px; line-height: 50px; margin-top: 60px;">Welcome to the SR 520 Construction Corner Dashboard</h1>
            <p><strong></strong></p>
            <a href="/projectForm" style="display: inline-block; padding: 10px 20px; font-size: 20px; background-color: #007b5f; color: #ffffff; text-decoration: none; border-radius: 5px;">
                Enter a new closure
            </a>      &nbsp;&nbsp;&nbsp; <a href="/pdf-upload" style="display: inline-block; padding: 10px 20px; font-size: 20px; background-color: #007b5f; color: #ffffff; text-decoration: none; border-radius: 5px;">Upload Files</a> &nbsp;&nbsp;&nbsp; <a href="#past-closures" style="display: inline-block; padding: 10px 20px; font-size: 20px; background-color: #007b5f; color: #ffffff; text-decoration: none; border-radius: 5px;"> View Closures</a>
              
            </a>  <br><br>
        </div>
        <!-- <div id="past-closures"></div> -->

        <section style="margin: 3%;">
            <h2 class="wdot-dkgreen" style="font-size: 24px; font-weight: 600;">Current and Past Closures:</h2>
            <div id="past-closures"></div>
            <!-- This is where we want the alerts to show -->
                    <div id="alertPlaceholder">

                      <!-- <div class="alert alert-success" role="alert">
                       Closure edited successfully.
                      </div>
                      <div class="alert alert-danger" role="alert">
                     D'oh! Your closure edit didn't work--please try again. 
                      </div>
                       -->
                    </div>

            <div class="accordion" id="closureAccordion">
                <% projects.forEach((project, index) => { %>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading<%= index %>">
                            <button class="accordion-button fw-600" type="button" style="font-size: 18px; line-height: 30px; font-weight:500;" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="true" aria-controls="collapse<%= index %>">
                                <%= project.activityName %>
                            </button>
                        </h2>
                        <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#closureAccordion">
                          <div class="accordion-body" style="font-size: 18px;">
                            <strong>Activity Name:</strong>
                            <input type="text" name="activityName" value="<%= project.activityName %>" disabled><br>
          
                         <div class="date-container">
                          <div class="date-item">
                              <strong>Start Date:</strong>
                              <input type="date" name="startDate" value="<%= project.startDate.toISOString().split('T')[0] %>" disabled>
                          </div>
                      
                          <div class="date-item">
                              <strong>End Date:</strong>
                              <input type="date" name="endDate" value="<%= project.endDate ? project.endDate.toISOString().split('T')[0] : '' %>" disabled>
                          </div>
                      </div>
                                          <strong>Time:</strong>
                            <input type="text" name="time" value="<%= project.time || '' %>" disabled>
                            <strong>Location:</strong>
                            <input type="text" class="mb-3" name="location" value="<%= project.location || '' %>" disabled>

                            
                            <strong>Description:</strong>
                            <input type="text" name="description" value="<%= project.description || '' %>" disabled>
          
                            <strong>Traffic Description:</strong>
                            <input type="text" name="trafficDescription" value="<%= project.trafficDescription || '' %>" disabled>
                                                        
                            <strong>Activity Type:</strong>
                            <div>
                              <% allActivityTypes.forEach(type => { %>
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" value="<%=type %>" disabled
                                  <% if (project.activityType && project.activityType.includes(type)) { %>checked<% } %> 
                                  id="activity_<%= type.replace(/ /g, '_') %>" name="activityType[]">
                                  <label class="form-check-label" for="activity_<%=type.replace(/ /g, '_') %>"><%= type %></label>
                                </div>
                              <% }); %>
                            </div>
                            
                            <strong>Timing Features:</strong>
                            <div>
                              <% allTimingFeatures.forEach(feature => { %>
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" value="<%=feature %>" disabled
                                  <% if (project.timingFeatures && project.timingFeatures.includes(feature)) { %>checked<% } %> 
                                  id="timing_<%= feature.replace(/ /g, '_') %>" name="timingFeatures[]">
                                  <label class="form-check-label" for="timing_<%=feature.replace(/ /g, '_') %>"><%= feature %></label>
                                </div>
                              <% }); %>
                            </div>
                            
                            <strong>Impact Type:</strong>
                            <div>
                              <% allImpactTypes.forEach(impact => { %>
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" value="<%=impact %>" disabled
                                  <% if (project.impactType && project.impactType.includes(impact)) { %>checked<% } %> 
                                  id="impact_<%= impact.replace(/ /g, '_') %>" name="impactType[]">
                                  <label class="form-check-label" for="impact_<%=impact.replace(/ /g, '_') %>"><%= impact %></label>
                                </div>
                              <% }); %>
                            </div>
                            
              
                            <!-- const imgElement = accordionItem.querySelector(`#img${index}`);
                            imgElement.src = data.imageUrl;
                            imgElement.style.display = 'block';   -->

                            <strong>Image URL:</strong>
                                    <% if (project.imageUrl){
                            
                                      %>                                 
                                    <a href="<%=project.imageUrl %>" target="_blank"><img id="img<%=index %>" class="img-fluid" src="<%= project.imageUrl %>" alt="Closure Image" style="max-width: 900px;"></a>
                                    <% } else { %>
                                    <span class="edit-image">Replace image</span>
                                    <img id="img<%=index %>" class="img-fluid" src="" alt="Closure Image" style="display: none; max-width: 700px;">
                                    <% } %><br><br>

                                    <input type="file" name="image" id="image" disabled><br> 

                                               <strong>Location:</strong>
                                                <input type="text" class="mb-3" name="location" value="<%= project.location || '' %>" disabled>
                            
                                                <strong>Map Data:</strong>
                                                <input type="text" name="mapData" value="<%= JSON.stringify(project.mapData) || '' %>" disabled>
                            
                                                <strong>Banner Content:</strong>
                                                <input type="text" name="bannerContent" value="<%= project.bannerContent || '' %>" disabled>
                            
                                                <strong>Post Date:</strong>
                                                <input type="date" name="postDate" value="<%= project.postDate.toISOString().split('T')[0] %>" disabled>
                            
                                                <strong>Remove Date:</strong>
                                                <input type="date" name="removeDate" value="<%= project.removeDate ? project.removeDate.toISOString().split('T')[0] : '' %>" disabled>
                            
                                                <strong>Contact:</strong>
                                                <input type="text" name="contact" value="<%= project.contact || '' %>" disabled>
                            
                                                <strong>Created At:</strong>
                                                <input type="date" name="createdAt" value="<%= project.createdAt.toISOString().split('T')[0] %>" disabled>
                            
                                                <strong>Updated At:</strong>
                                                <input type="date" name="updatedAt" value="<%= project.updatedAt.toISOString().split('T')[0] %>" disabled><br>
                            
                                                <button class="btn btn-md btn-secondary edit-btn" data-id="<%= project._id %>">Edit</button>
                                                <button class="btn btn-md btn-danger delete-btn" data-id="<%= project._id %>">Delete</button>
                                            </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            </section>

                        </div>

<!-- END Form's HTML -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      console.log("Script started");

      const alertPlaceholder = document.getElementById('alertPlaceholder');

      function showAlert(type, message) {
          alertPlaceholder.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
          setTimeout(() => alertPlaceholder.innerHTML = '', 5000);
      }

      document.addEventListener('click', async function(e) {
          const editBtn = e.target.closest('.edit-btn');
          const deleteBtn = e.target.closest('.delete-btn');
          const accordionItem = e.target.closest('.accordion-item');

          if (editBtn) {
              const inputs = accordionItem.querySelectorAll('input');
              const fileInput = accordionItem.querySelector('input[type=file]');
              const id = editBtn.getAttribute('data-id');

              // Toggle the input fields' disabled state
              inputs.forEach(input => input.disabled = !input.disabled);

              // Toggle button text between 'Edit' and 'Save'
              if (editBtn.innerText === 'Edit') {
                  editBtn.innerText = 'Save';
              } else {
                  const formData = new FormData();

                  inputs.forEach(input => {
                      if (input.type !== 'file' && input.type !== 'checkbox') {
                          formData.append(input.name, input.value);
                      }
                  });

                  // Handle checkbox arrays
                  ['activityType', 'timingFeatures', 'impactType'].forEach(name => {
                      const checkedValues = Array.from(accordionItem.querySelectorAll(`input[name="${name}[]"]:checked`)).map(input => input.value);
                      formData.append(name, JSON.stringify(checkedValues));
                  });

                  if (fileInput.files[0]) {
                      formData.append('image', fileInput.files[0]);
                  }

                  try {
                      const response = await fetch(`/api/projects/${id}`, {
                          method: 'PUT',
                          body: formData
                      });

                      if (!response.ok) {
                          throw new Error('Network response was not ok');
                      }

                      const data = await response.json();

                      if (data.error) {
                          console.error('Error:', data.error);
                          showAlert('danger', 'Failed to update closure. Please try again.');
                      } else {
                          showAlert('success', 'Closure updated successfully!');
                      }

                  } catch (err) {
                      console.error('Fetch error:', err);
                      showAlert('danger', 'An error occurred. Please try again.');
                  }
              }
          }

          if (deleteBtn) {
              const id = deleteBtn.getAttribute('data-id');

              if (confirm('Are you sure you want to delete this closure?')) {
                  try {
                      const response = await fetch(`/${id}`, {
                          method: 'DELETE'
                      });

                      if (!response.ok) {
                          throw new Error('Network response was not ok');
                      }

                      const data = await response.json();

                      if (data.error) {
                          throw new Error(data.error);
                      }

                      accordionItem.remove();
                      alert('Closure deleted successfully!');

                  } catch (err) {
                      console.error('Error deleting closure:', err);
                      alert('There was an error deleting the closure.');
                  }
              }
          }
      });
  });
</script>

  
    </body>
    </html>
